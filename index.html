<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS Connect Platform</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Basic styling for the message box */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .message-box.error {
            background-color: #f44336; /* Red for error */
        }
        .message-box.show {
            display: block;
            opacity: 1;
        }
        /* Remove modal styles, as it's no longer used for calendar day details */
        .modal, .modal-content, .close-button {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Message Box for alerts/confirmations -->
    <div id="messageBox" class="message-box"></div>

    <!-- Modal for showing daily events (now hidden as per list view) -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="modalDate" class="text-xl font-semibold mb-3"></h3>
            <div id="modalEventsList" class="space-y-2">
                <!-- Events for the selected day will be loaded here -->
            </div>
            <p id="noEventsMessage" class="text-gray-500 hidden">No events for this day.</p>
        </div>
    </div>

    <!-- Header Section -->
    <header class="bg-blue-800 text-white p-4 shadow-md rounded-b-lg">
        <div class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-2xl font-bold mb-2 sm:mb-0">EMS Connect</h1>
            <div class="text-sm">
                User ID: <span id="userIdDisplay" class="font-medium">Loading...</span>
            </div>
        </div>
    </header>

    <!-- Emergency Alert Banner -->
    <section id="emergencyAlertSection" class="bg-red-600 text-white p-3 text-center font-semibold hidden rounded-lg mx-4 mt-4 shadow-lg">
        <div class="container mx-auto flex items-center justify-center">
            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            <span id="emergencyAlertText"></span>
        </div>
    </section>

    <!-- Main Content Area -->
    <main class="container mx-auto p-4 flex-grow grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Centralized Announcement & News Feed -->
        <section class="md:col-span-2 bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-semibold text-blue-800 mb-4 border-b pb-2">Agency Announcements & News</h2>
            <div id="announcementsList" class="space-y-4">
                <!-- Announcements will be loaded here -->
                <p class="text-gray-500" id="loadingAnnouncements">Loading announcements...</p>
            </div>
            <!-- Simple form to add an announcement (for demo/admin) -->
            <div id="addAnnouncementForm" class="mt-6 pt-4 border-t hidden">
                <h3 class="text-xl font-medium text-blue-700 mb-3">Add New Announcement</h3>
                <input type="text" id="newAnnouncementTitle" placeholder="Announcement Title" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">
                <textarea id="newAnnouncementContent" placeholder="Announcement Details" rows="3" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500"></textarea>
                <select id="newAnnouncementCategory" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Select Category</option>
                    <option value="Operational">Operational</option>
                    <option value="HR">HR</option>
                    <option value="Training">Training</option>
                    <option value="Safety">Safety</option>
                    <option value="General">General</option>
                </select>
                <button id="addAnnouncementBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Post Announcement
                </button>
            </div>
        </section>

        <!-- Right Sidebar for Documents, Training, Feedback, Calendar, and Issue Reporting -->
        <div class="md:col-span-1 space-y-6">

            <!-- Document & Policy Updates Repository -->
            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4 border-b pb-2">Document & Policy Updates</h2>
                <div id="documentsList" class="space-y-3">
                    <!-- Documents will be loaded here -->
                    <p class="text-gray-500" id="loadingDocuments">Loading documents...</p>
                </div>
                <!-- Simple form to add a document (for demo/admin) -->
                <div id="addDocumentForm" class="mt-6 pt-4 border-t hidden">
                    <h3 class="text-xl font-medium text-blue-700 mb-3">Add New Document</h3>
                    <input type="text" id="newDocumentTitle" placeholder="Document Title" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="newDocumentVersion" placeholder="Version (e.g., 1.0)" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">
                    <button id="addDocumentBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                        Add Document
                    </button>
                </div>
            </section>

            <!-- Training & Resource Updates -->
            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4 border-b pb-2">Training & Resource Updates</h2>
                <div id="trainingList" class="space-y-3">
                    <p class="text-gray-500" id="loadingTraining">Loading training updates...</p>
                </div>
                <div id="addTrainingForm" class="mt-6 pt-4 border-t hidden">
                    <h3 class="text-xl font-medium text-blue-700 mb-3">Add New Training Update</h3>
                    <input type="text" id="newTrainingTitle" placeholder="Training Title" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="newTrainingDescription" placeholder="Description" rows="2" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <button id="addTrainingBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                        Add Training
                    </button>
                </div>
            </section>

            <!-- Calendar Section (Now Yearly List View) -->
            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4 border-b pb-2">Agency Calendar</h2>
                <div id="yearlyCalendarList" class="space-y-4">
                    <!-- Calendar events will be loaded here in list view -->
                    <p class="text-gray-500 text-center" id="loadingCalendar">Loading calendar events...</p>
                </div>

                <!-- Form to add new calendar events (admin only) -->
                <div id="addCalendarEventForm" class="mt-6 pt-4 border-t hidden">
                    <h3 class="text-xl font-medium text-blue-700 mb-3">Add New Calendar Event</h3>
                    <input type="text" id="newEventTitle" placeholder="Event Title" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">
                    <input type="date" id="newEventDate" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="newEventDescription" placeholder="Event Description" rows="2" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <button id="addEventBtn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                        Add Event
                    </button>
                </div>
            </section>

            <!-- Report an Issue Section -->
            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4 border-b pb-2">Report an Issue</h2>
                <p class="text-gray-600 mb-4">Report any operational issues, equipment malfunctions, or other concerns.</p>
                <input type="text" id="issueTitle" placeholder="Issue Summary (e.g., Ambulance 3 AC broken)" class="w-full p-2 border border-gray-300 rounded-md mb-3 focus:ring-red-500 focus:border-red-500">
                <textarea id="issueDescription" placeholder="Detailed description of the issue..." rows="4" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring-red-500 focus:border-red-500"></textarea>
                <button id="submitIssueBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Submit Issue Report
                </button>
            </section>

            <!-- Reported Issues (Admin View) -->
            <section id="reportedIssuesAdminView" class="bg-white p-6 rounded-lg shadow-lg hidden">
                <h2 class="text-2xl font-semibold text-red-800 mb-4 border-b pb-2">Reported Issues (Admin View)</h2>
                <div id="issuesList" class="space-y-3">
                    <p class="text-gray-500" id="loadingIssues">Loading reported issues...</p>
                </div>
            </section>

            <!-- Feedback & Clarification Channel -->
            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold text-blue-800 mb-4 border-b pb-2">Feedback & Clarification</h2>
                <p class="text-gray-600 mb-4">Have questions or need clarification on an update? Send us your feedback.</p>
                <textarea id="feedbackContent" placeholder="Your feedback or question..." rows="4" class="w-full p-2 border border-gray-300 rounded-md mb-4 focus:ring-blue-500 focus:border-blue-500"></textarea>
                <button id="submitFeedbackBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition duration-300 ease-in-out">
                    Submit Feedback
                </button>
            </section>

        </div>
    </main>

    <!-- Footer Section -->
    <footer class="bg-gray-200 text-gray-700 p-4 text-center mt-6 rounded-t-lg">
        <div class="container mx-auto">
            &copy; 2025 EMS Connect. All rights reserved.
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, doc, onSnapshot, addDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let isAdmin = false; // Flag to determine if the current user is an admin

        let allCalendarEvents = []; // To store all fetched calendar events


        // Function to display messages (success/error)
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box ${type} show`;
            setTimeout(() => {
                messageBox.className = `message-box ${type}`;
            }, 3000); // Hide after 3 seconds
        }

        // Function to check if the user is an admin (for this prototype)
        function checkAdminStatus(currentUserId) {
            // For demo purposes, any user ID starting with 'admin-' will be considered an admin.
            // In a real application, this would involve a secure backend check against a user roles database.
            return currentUserId && currentUserId.startsWith('admin-');
        }

        // Function to toggle visibility of admin forms and sections
        function toggleAdminForms() {
            const addAnnouncementForm = document.getElementById('addAnnouncementForm');
            const addDocumentForm = document.getElementById('addDocumentForm');
            const addTrainingForm = document.getElementById('addTrainingForm');
            const addCalendarEventForm = document.getElementById('addCalendarEventForm');
            const reportedIssuesAdminView = document.getElementById('reportedIssuesAdminView'); // New admin view section

            if (isAdmin) {
                addAnnouncementForm.classList.remove('hidden');
                addDocumentForm.classList.remove('hidden');
                addTrainingForm.classList.remove('hidden');
                addCalendarEventForm.classList.remove('hidden');
                reportedIssuesAdminView.classList.remove('hidden'); // Show admin issues view
            } else {
                addAnnouncementForm.classList.add('hidden');
                addDocumentForm.classList.add('hidden');
                addTrainingForm.classList.add('hidden');
                addCalendarEventForm.classList.add('hidden');
                reportedIssuesAdminView.classList.add('hidden'); // Hide admin issues view
            }
        }


        // Initialize Firebase and set up authentication
        async function initializeFirebaseAndAuth() {
            try {
                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Listen for auth state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // User is signed in
                        userId = user.uid;
                        document.getElementById('userIdDisplay').textContent = userId;
                        console.log("Firebase initialized and user authenticated. User ID:", userId);

                        isAdmin = checkAdminStatus(userId); // Check admin status
                        toggleAdminForms(); // Adjust form visibility based on admin status

                        // Once authenticated, start listening for data
                        setupRealtimeListeners();
                    } else {
                        // User is signed out, try to sign in
                        if (initialAuthToken) {
                            // Sign in with custom token if available
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Sign in anonymously if no custom token
                            const anonymousId = `anon-${crypto.randomUUID()}`;
                            await signInAnonymously(auth);
                            if (!auth.currentUser) {
                                userId = anonymousId;
                                document.getElementById('userIdDisplay').textContent = userId;
                                console.log("Firebase initialized and signed in anonymously. User ID:", userId);
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showMessage("Failed to initialize the platform. Please try again.", "error");
                document.getElementById('userIdDisplay').textContent = 'Error';
            }
        }

        // Function to acknowledge an item
        async function acknowledgeItem(collectionName, itemId) {
            // Ensure userId is available before attempting to acknowledge
            if (!userId) {
                 // Wait for authentication to complete if userId is not yet set
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, user => {
                        if (user) {
                            userId = user.uid;
                            unsubscribe(); // Stop listening once authenticated
                            resolve();
                        } else {
                            // If initialAuthToken is missing and anonymous sign-in failed,
                            // or if for some reason user ID isn't set, resolve immediately.
                            // This scenario is less likely with the anonymous fallback.
                            resolve();
                        }
                    });
                });
            }

            if (!db || !userId) {
                showMessage("Authentication required to acknowledge items. Please refresh or check connection.", "error");
                return;
            }

            const itemRef = doc(db, `artifacts/${appId}/public/data/${collectionName}`, itemId);
            try {
                await updateDoc(itemRef, {
                    acknowledgedBy: arrayUnion(userId) // Add current user's ID to the array
                });
                showMessage(`Item acknowledged in ${collectionName}!`);
            } catch (e) {
                console.error(`Error acknowledging item in ${collectionName}: `, e);
                // Specifically check for 'PERMISSION_DENIED' if rules are strict
                if (e.code === 'permission-denied') {
                    showMessage("You do not have permission to perform this action.", "error");
                } else {
                    showMessage(`Error acknowledging item. Please try again.`, "error");
                }
            }
        }

        // Setup real-time listeners for different data collections
        function setupRealtimeListeners() {
            if (!db || !userId) {
                console.error("Firestore not initialized or userId not available.");
                return;
            }

            // Re-usable click handler for acknowledgement buttons
            function handleAcknowledgeClick(event) {
                const button = event.target;
                const itemId = button.dataset.id;
                const collectionName = button.dataset.collection;
                if (itemId && collectionName) {
                    acknowledgeItem(collectionName, itemId);
                }
            }

            // 1. Announcements Listener
            const announcementsColRef = collection(db, `artifacts/${appId}/public/data/announcements`);
            const qAnnouncements = query(announcementsColRef); // Fetch all and sort in JS

            onSnapshot(qAnnouncements, (snapshot) => {
                const announcementsList = document.getElementById('announcementsList');
                if (announcementsList) { // Added null check
                    announcementsList.innerHTML = ''; // Clear existing announcements
                }
                const loadingAnnouncements = document.getElementById('loadingAnnouncements');
                if (loadingAnnouncements) { // Added null check
                    loadingAnnouncements.style.display = 'none';
                }


                if (snapshot.empty) {
                    if (announcementsList) { // Added null check
                        announcementsList.innerHTML = '<p class="text-gray-500">No announcements yet.</p>';
                    }
                    return;
                }

                const announcements = [];
                snapshot.forEach(doc => {
                    announcements.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp in JavaScript
                announcements.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                announcements.forEach(announcement => {
                    const date = announcement.timestamp ? new Date(announcement.timestamp.toDate()).toLocaleString() : 'N/A';
                    const categoryClass = announcement.category ? `bg-blue-100 text-blue-800` : `bg-gray-100 text-gray-700`;
                    const acknowledgedUsers = announcement.acknowledgedBy || [];
                    const hasAcknowledged = acknowledgedUsers.includes(userId);
                    const acknowledgeBtnClass = hasAcknowledged ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600';
                    const acknowledgeBtnText = hasAcknowledged ? 'Acknowledged' : 'Mark as Read';
                    const acknowledgedListHtml = acknowledgedUsers.length > 0 ?
                        `<p class="text-xs text-gray-500 mt-1">Acknowledged by (${acknowledgedUsers.length}): ${acknowledgedUsers.join(', ')}</p>` :
                        '<p class="text-xs text-gray-500 mt-1">No acknowledgements yet.</p>';


                    const announcementHtml = `
                        <div class="border border-gray-200 p-4 rounded-md shadow-sm bg-gray-50">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-lg font-semibold text-gray-800">${announcement.title}</h3>
                                <span class="text-xs ${categoryClass} px-2 py-1 rounded-full">${announcement.category || 'General'}</span>
                            </div>
                            <p class="text-gray-700 text-sm mb-2">${announcement.content}</p>
                            <p class="text-xs text-gray-500">Posted: ${date} by ${announcement.postedBy || 'Admin'}</p>
                            ${acknowledgedListHtml}
                            <button data-id="${announcement.id}" data-collection="announcements"
                                class="acknowledge-btn ${acknowledgeBtnClass} text-white font-bold py-1 px-3 rounded-md shadow-sm mt-3 text-sm"
                                ${hasAcknowledged ? 'disabled' : ''}>
                                ${acknowledgeBtnText}
                            </button>
                        </div>
                    `;
                    if (announcementsList) { // Added null check
                        announcementsList.insertAdjacentHTML('beforeend', announcementHtml);
                    }
                });

                // Add event listeners to newly rendered buttons
                document.querySelectorAll('#announcementsList .acknowledge-btn').forEach(button => {
                    // Remove existing listeners to prevent duplicates
                    button.removeEventListener('click', handleAcknowledgeClick);
                    // Add new listener
                    button.addEventListener('click', handleAcknowledgeClick);
                });

            }, (error) => {
                console.error("Error fetching announcements:", error);
                showMessage("Failed to load announcements.", "error");
                const loadingAnnouncements = document.getElementById('loadingAnnouncements');
                if (loadingAnnouncements) { // Added null check
                    loadingAnnouncements.textContent = 'Failed to load announcements.';
                }
            });


            // 2. Documents Listener
            const documentsColRef = collection(db, `artifacts/${appId}/public/data/documents`);
            const qDocuments = query(documentsColRef); // Fetch all and sort in JS

            onSnapshot(qDocuments, (snapshot) => {
                const documentsList = document.getElementById('documentsList');
                if (documentsList) { // Added null check
                    documentsList.innerHTML = '';
                }
                const loadingDocuments = document.getElementById('loadingDocuments');
                if (loadingDocuments) { // Added null check
                    loadingDocuments.style.display = 'none';
                }

                if (snapshot.empty) {
                    if (documentsList) { // Added null check
                        documentsList.innerHTML = '<p class="text-gray-500">No documents yet.</p>';
                    }
                    return;
                }

                const documents = [];
                snapshot.forEach(doc => {
                    documents.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp in JavaScript
                documents.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                documents.forEach(docItem => {
                    const date = docItem.timestamp ? new Date(docItem.timestamp.toDate()).toLocaleDateString() : 'N/A';
                    const acknowledgedUsers = docItem.acknowledgedBy || [];
                    const hasAcknowledged = acknowledgedUsers.includes(userId);
                    const acknowledgeBtnClass = hasAcknowledged ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600';
                    const acknowledgeBtnText = hasAcknowledged ? 'Acknowledged' : 'Mark as Read';
                    const acknowledgedListHtml = acknowledgedUsers.length > 0 ?
                        `<p class="text-xs text-gray-500 mt-1">Acknowledged by (${acknowledgedUsers.length}): ${acknowledgedUsers.join(', ')}</p>` :
                        '<p class="text-xs text-gray-500 mt-1">No acknowledgements yet.</p>';

                    const documentHtml = `
                        <div class="p-3 border border-gray-200 rounded-md bg-gray-50">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-800 font-medium">${docItem.title} <span class="text-xs text-gray-500">(v${docItem.version})</span></span>
                                <span class="text-xs text-gray-500">Updated: ${date}</span>
                            </div>
                            ${acknowledgedListHtml}
                            <button data-id="${docItem.id}" data-collection="documents"
                                class="acknowledge-btn ${acknowledgeBtnClass} text-white font-bold py-1 px-3 rounded-md shadow-sm mt-3 text-sm"
                                ${hasAcknowledged ? 'disabled' : ''}>
                                ${acknowledgeBtnText}
                            </button>
                        </div>
                    `;
                    if (documentsList) { // Added null check
                        documentsList.insertAdjacentHTML('beforeend', documentHtml);
                    }
                });

                // Add event listeners to newly rendered buttons
                document.querySelectorAll('#documentsList .acknowledge-btn').forEach(button => {
                    button.removeEventListener('click', handleAcknowledgeClick);
                    button.addEventListener('click', handleAcknowledgeClick);
                });

            }, (error) => {
                console.error("Error fetching documents:", error);
                showMessage("Failed to load documents.", "error");
                const loadingDocuments = document.getElementById('loadingDocuments');
                if (loadingDocuments) { // Added null check
                    loadingDocuments.textContent = 'Failed to load documents.';
                }
            });

            // 3. Training Updates Listener
            const trainingColRef = collection(db, `artifacts/${appId}/public/data/training_updates`);
            const qTraining = query(trainingColRef); // Fetch all and sort in JS

            onSnapshot(qTraining, (snapshot) => {
                const trainingList = document.getElementById('trainingList');
                if (trainingList) { // Added null check
                    trainingList.innerHTML = '';
                }
                const loadingTraining = document.getElementById('loadingTraining');
                if (loadingTraining) { // Added null check
                    loadingTraining.style.display = 'none';
                }


                if (snapshot.empty) {
                    if (trainingList) { // Added null check
                        trainingList.innerHTML = '<p class="text-gray-500">No training updates yet.</p>';
                    }
                    return;
                }

                const trainingUpdates = [];
                snapshot.forEach(doc => {
                    trainingUpdates.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp in JavaScript
                trainingUpdates.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                trainingUpdates.forEach(updateItem => {
                    const date = updateItem.timestamp ? new Date(updateItem.timestamp.toDate()).toLocaleDateString() : 'N/A';
                    const acknowledgedUsers = updateItem.acknowledgedBy || [];
                    const hasAcknowledged = acknowledgedUsers.includes(userId);
                    const acknowledgeBtnClass = hasAcknowledged ? 'bg-gray-400 cursor-not-allowed' : 'bg-orange-500 hover:bg-orange-600';
                    const acknowledgeBtnText = hasAcknowledged ? 'Acknowledged' : 'Mark as Read';
                    const acknowledgedListHtml = acknowledgedUsers.length > 0 ?
                        `<p class="text-xs text-gray-500 mt-1">Acknowledged by (${acknowledgedUsers.length}): ${acknowledgedUsers.join(', ')}</p>` :
                        '<p class="text-xs text-gray-500 mt-1">No acknowledgements yet.</p>';

                    const trainingHtml = `
                        <div class="p-3 border border-gray-200 rounded-md bg-gray-50">
                            <h3 class="text-md font-medium text-gray-800">${updateItem.title}</h3>
                            <p class="text-gray-700 text-sm mb-1">${updateItem.description}</p>
                            <p class="text-xs text-gray-500">Posted: ${date}</p>
                            ${acknowledgedListHtml}
                            <button data-id="${updateItem.id}" data-collection="training_updates"
                                class="acknowledge-btn ${acknowledgeBtnClass} text-white font-bold py-1 px-3 rounded-md shadow-sm mt-3 text-sm"
                                ${hasAcknowledged ? 'disabled' : ''}>
                                ${acknowledgeBtnText}
                            </button>
                        </div>
                    `;
                    if (trainingList) { // Added null check
                        trainingList.insertAdjacentHTML('beforeend', trainingHtml);
                    }
                });

                // Add event listeners to newly rendered buttons
                document.querySelectorAll('#trainingList .acknowledge-btn').forEach(button => {
                    button.removeEventListener('click', handleAcknowledgeClick);
                    button.addEventListener('click', handleAcknowledgeClick);
                });

            }, (error) => {
                console.error("Error fetching training updates:", error);
                showMessage("Failed to load training updates.", "error");
                const loadingTraining = document.getElementById('loadingTraining');
                if (loadingTraining) { // Added null check
                    loadingTraining.textContent = 'Failed to load training updates.';
                }
            });

            // 4. Calendar Events Listener (UPDATED for List View)
            const calendarEventsColRef = collection(db, `artifacts/${appId}/public/data/calendar_events`);
            const qCalendarEvents = query(calendarEventsColRef);

            onSnapshot(qCalendarEvents, (snapshot) => {
                const loadingCalendar = document.getElementById('loadingCalendar');
                if (loadingCalendar) { // Added null check
                    loadingCalendar.style.display = 'none';
                }
                allCalendarEvents = []; // Clear previous events
                snapshot.forEach(doc => {
                    allCalendarEvents.push({ id: doc.id, ...doc.data() });
                });
                renderYearlyCalendarList(); // Re-render the new yearly list calendar
            }, (error) => {
                console.error("Error fetching calendar events:", error);
                showMessage("Failed to load calendar events.", "error");
                const loadingCalendar = document.getElementById('loadingCalendar');
                if (loadingCalendar) { // Added null check
                    loadingCalendar.textContent = 'Failed to load calendar events.';
                }
            });

            // 5. Reported Issues Listener (ADMIN VIEW)
            const issuesColRef = collection(db, `artifacts/${appId}/public/data/agency_issues`);
            const qIssues = query(issuesColRef);

            onSnapshot(qIssues, (snapshot) => {
                const issuesList = document.getElementById('issuesList');
                if (issuesList) { // Added null check
                    issuesList.innerHTML = '';
                }
                const loadingIssues = document.getElementById('loadingIssues');
                if (loadingIssues) { // Added null check
                    loadingIssues.style.display = 'none';
                }

                if (snapshot.empty) {
                    if (issuesList) { // Added null check
                        issuesList.innerHTML = '<p class="text-gray-500">No issues reported yet.</p>';
                    }
                    return;
                }

                const issues = [];
                snapshot.forEach(doc => {
                    issues.push({ id: doc.id, ...doc.data() });
                });

                // Sort by timestamp (most recent first)
                issues.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

                issues.forEach(issue => {
                    const date = issue.timestamp ? new Date(issue.timestamp.toDate()).toLocaleString() : 'N/A';
                    issuesList.innerHTML += `
                        <div class="p-3 border border-red-200 rounded-md bg-red-50">
                            <h3 class="text-md font-semibold text-red-800">${issue.title}</h3>
                            <p class="text-gray-700 text-sm mb-1">${issue.description}</p>
                            <p class="text-xs text-gray-500">Reported by: ${issue.reportedBy || 'Unknown User'} on ${date}</p>
                        </div>
                    `;
                });
            }, (error) => {
                console.error("Error fetching reported issues:", error);
                showMessage("Failed to load reported issues.", "error");
                const loadingIssues = document.getElementById('loadingIssues');
                if (loadingIssues) { // Added null check
                    loadingIssues.textContent = 'Failed to load reported issues.';
                }
            });
        }

        // Calendar rendering function for yearly list view (NEW)
        function renderYearlyCalendarList() {
            const yearlyCalendarList = document.getElementById('yearlyCalendarList');
            if (!yearlyCalendarList) return; // Add null check for the container

            yearlyCalendarList.innerHTML = ''; // Clear previous content

            if (allCalendarEvents.length === 0) {
                yearlyCalendarList.innerHTML = '<p class="text-gray-500 text-center">No upcoming events for the year.</p>';
                return;
            }

            // Sort events chronologically by eventDate
            const sortedEvents = [...allCalendarEvents].sort((a, b) => {
                if (a.eventDate < b.eventDate) return -1;
                if (a.eventDate > b.eventDate) return 1;
                return 0;
            });

            let currentMonthGroup = '';
            let currentYearGroup = '';

            sortedEvents.forEach(eventItem => {
                const eventDate = new Date(eventItem.eventDate + 'T00:00:00'); // Ensure date is parsed correctly
                const eventMonth = eventDate.toLocaleDateString('en-US', { month: 'long' });
                const eventYear = eventDate.getFullYear();
                const eventDateFormatted = eventDate.toLocaleDateString('en-US', {
                    weekday: 'short', year: 'numeric', month: 'long', day: 'numeric'
                });
                const postedDate = eventItem.timestamp ? new Date(eventItem.timestamp.toDate()).toLocaleDateString() : 'N/A';

                // Check if new month/year heading is needed
                if (eventMonth !== currentMonthGroup || eventYear !== currentYearGroup) {
                    currentMonthGroup = eventMonth;
                    currentYearGroup = eventYear;
                    const monthHeading = document.createElement('h4');
                    monthHeading.className = 'text-lg font-semibold text-blue-700 mt-4 mb-2 border-b-2 border-blue-200 pb-1';
                    monthHeading.textContent = `${eventMonth} ${eventYear}`;
                    yearlyCalendarList.appendChild(monthHeading);
                }

                // Add event item
                const eventDiv = document.createElement('div');
                eventDiv.className = 'p-3 border border-gray-200 rounded-md bg-gray-50 mb-2';
                eventDiv.innerHTML = `
                    <p class="font-semibold text-gray-800">${eventItem.title}</p>
                    <p class="text-sm text-gray-700 mb-1">Date: ${eventDateFormatted}</p>
                    <p class="text-xs text-gray-600">${eventItem.description}</p>
                    <p class="text-xs text-gray-500 mt-1">Posted by: ${eventItem.postedBy || 'Admin'} on ${postedDate}</p>
                `;
                yearlyCalendarList.appendChild(eventDiv);
            });
        }


        // Function to add a new announcement
        document.getElementById('addAnnouncementBtn').addEventListener('click', async () => {
            const title = document.getElementById('newAnnouncementTitle').value.trim();
            const content = document.getElementById('newAnnouncementContent').value.trim();
            const category = document.getElementById('newAnnouncementCategory').value;

            if (!title || !content) {
                showMessage("Please fill in both title and content for the announcement.", "error");
                return;
            }
            if (!isAdmin) {
                showMessage("You do not have permission to post announcements.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/announcements`), {
                    title: title,
                    content: content,
                    category: category,
                    timestamp: serverTimestamp(),
                    postedBy: userId, // Use current user ID
                    acknowledgedBy: [] // Initialize with an empty array
                });
                showMessage("Announcement posted successfully!");
                document.getElementById('newAnnouncementTitle').value = '';
                document.getElementById('newAnnouncementContent').value = '';
                document.getElementById('newAnnouncementCategory').value = '';
            } catch (e) {
                console.error("Error posting announcement: ", e);
                showMessage("Error posting announcement. Please try again.", "error");
            }
        });

        // Function to add a new document
        document.getElementById('addDocumentBtn').addEventListener('click', async () => {
            const title = document.getElementById('newDocumentTitle').value.trim();
            const version = document.getElementById('newDocumentVersion').value.trim();

            if (!title || !version) {
                showMessage("Please fill in both title and version for the document.", "error");
                return;
            }
            if (!isAdmin) {
                showMessage("You do not have permission to add documents.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/documents`), {
                    title: title,
                    version: version,
                    timestamp: serverTimestamp(),
                    uploadedBy: userId,
                    acknowledgedBy: [] // Initialize with an empty array
                });
                showMessage("Document added successfully!");
                document.getElementById('newDocumentTitle').value = '';
                document.getElementById('newDocumentVersion').value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("Error adding document. Please try again.", "error");
            }
        });

        // Function to add a new training update
        document.getElementById('addTrainingBtn').addEventListener('click', async () => {
            const title = document.getElementById('newTrainingTitle').value.trim();
            const description = document.getElementById('newTrainingDescription').value.trim();

            if (!title || !description) {
                showMessage("Please fill in both title and description for the training update.", "error");
                return;
            }
            if (!isAdmin) {
                showMessage("You do not have permission to add training updates.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/training_updates`), {
                    title: title,
                    description: description,
                    timestamp: serverTimestamp(),
                    postedBy: userId,
                    acknowledgedBy: [] // Initialize with an empty array
                });
                showMessage("Training update added successfully!");
                document.getElementById('newTrainingTitle').value = '';
                document.getElementById('newTrainingDescription').value = '';
            } catch (e) {
                console.error("Error adding training update: ", e);
                showMessage("Error adding training update. Please try again.", "error");
            }
        });

        // Function to add a new calendar event
        document.getElementById('addEventBtn').addEventListener('click', async () => {
            const title = document.getElementById('newEventTitle').value.trim();
            const eventDate = document.getElementById('newEventDate').value; // YYYY-MM-DD format
            const description = document.getElementById('newEventDescription').value.trim();

            if (!title || !eventDate || !description) {
                showMessage("Please fill in all fields for the calendar event (title, date, description).", "error");
                return;
            }
            if (!isAdmin) {
                showMessage("You do not have permission to add calendar events.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/calendar_events`), {
                    title: title,
                    eventDate: eventDate, // Store as YYYY-MM-DD string
                    description: description,
                    timestamp: serverTimestamp(), // Timestamp of creation
                    postedBy: userId
                });
                showMessage("Calendar event added successfully!");
                document.getElementById('newEventTitle').value = '';
                document.getElementById('newEventDate').value = '';
                document.getElementById('newEventDescription').value = '';
            } catch (e) {
                console.error("Error adding calendar event: ", e);
                showMessage("Error adding calendar event. Please try again.", "error");
            }
        });

        // Function to submit an issue report
        document.getElementById('submitIssueBtn').addEventListener('click', async () => {
            const issueTitle = document.getElementById('issueTitle').value.trim();
            const issueDescription = document.getElementById('issueDescription').value.trim();

            if (!issueTitle || !issueDescription) {
                showMessage("Please provide both a summary and a description for the issue.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/agency_issues`), {
                    title: issueTitle,
                    description: issueDescription,
                    timestamp: serverTimestamp(),
                    reportedBy: userId
                });
                showMessage("Issue reported successfully! Admins will review it.");
                document.getElementById('issueTitle').value = '';
                document.getElementById('issueDescription').value = '';
            } catch (e) {
                console.error("Error submitting issue: ", e);
                showMessage("Error submitting issue. Please try again.", "error");
            }
        });


        // Function to submit feedback
        document.getElementById('submitFeedbackBtn').addEventListener('click', async () => {
            const feedbackContent = document.getElementById('feedbackContent').value.trim();

            if (!feedbackContent) {
                showMessage("Please enter your feedback before submitting.", "error");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/feedback`), {
                    content: feedbackContent,
                    timestamp: serverTimestamp(),
                    submittedBy: userId
                });
                showMessage("Feedback submitted successfully! Thank you.");
                document.getElementById('feedbackContent').value = '';
            } catch (e) {
                console.error("Error submitting feedback: ", e);
                showMessage("Error submitting feedback. Please try again.", "error");
            }
        });

        // Example for triggering an emergency alert (can be integrated with an admin panel)
        function triggerEmergencyAlert(message) {
            const alertSection = document.getElementById('emergencyAlertSection');
            const alertText = document.getElementById('emergencyAlertText');
            alertText.textContent = message;
            if (alertSection) { // Added null check
                 alertSection.classList.remove('hidden');
            }
            // Hide after a certain time, or require manual dismissal in a real app
            setTimeout(() => {
                if (alertSection) { // Added null check
                    alertSection.classList.add('hidden');
                }
            }, 10000); // Alert visible for 10 seconds
        }

        // Example: Trigger an alert after some time for demonstration
        // You can uncomment this to see an alert pop up after 5 seconds
        // window.onload = () => {
        //     setTimeout(() => {
        //         triggerEmergencyAlert("CRITICAL: All personnel report to staging area immediately for incident briefing.");
        //     }, 5000);
        // };

        // Initialize Firebase when the window loads
        window.onload = initializeFirebaseAndAuth;

    </script>
</body>
</html>
